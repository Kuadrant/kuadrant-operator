name: PR Conditional Build and Push Image to Quay.io Repo

on:
  pull_request_target:
    types: [labeled, opened, synchronize, reopened]

concurrency:
  group: pr-conditional-build-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  workflow-build:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.pull_request.labels.*.name, 'forked_image_approved') }}
    name: Calls build-images-base workflow
    steps:
      - name: Run build-images-base workflow
        uses: ./.github/workflows/build-images-base.yaml
        with:
          kuadrantOperatorVersion: ${{ github.event.pull_request.user.login }}-${{ github.event.pull_request.number }}
          kuadrantOperatorTag: ${{ github.event.pull_request.user.login }}-${{ github.event.pull_request.number }}
        secrets: inherit

  remove-label:
    runs-on: ubuntu-latest
    needs: workflow-build
    steps:
      - name: Remove forked_image_approved label after workflow is triggered
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          labels: forked_image_approved
          repo-token: ${{ secrets.GITHUB_TOKEN }}